% Impala Operating System
%
% Copyright (C) 2009 University of Wroclaw. Department of Computer Science
%    http://www.ii.uni.wroc.pl/
% Copyright (C) 2009 Mateusz Kocielski, Artur Koninski, Pawel Wieczorek
%    http://trzask.codepainters.com/impala/trac/
% All rights reserved.
%
% Redistribution and use in source and binary forms, with or without
% modification, are permitted provided that the following conditions
% are met:
% 1. Redistributions of source code must retain the above copyright
%  notice, this list of conditions and the following disclaimer.
% 2. Redistributions in binary form must reproduce the above copyright
%  notice, this list of conditions and the following disclaimer in the
%  documentation and/or other materials provided with the distribution.
%
% THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND
% ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
% IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
% ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE
% FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
% DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
% OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
% HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
% LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
% OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
% SUCH DAMAGE.
%
% $Id$


\section{Zarz±dzanie pamiêci±.}

% To mo¿e siê zmieniæ, mo¿emy z GRUB'a skorzystaæ.
Informacja o~ilo¶ci zainstalowanej pamiêci RAM na komputerze jest pobierana z~pamiêci CMOS.
Poniewa¿ CMOS jest star± technologi± to przechowuje tê~informacjê w~16bitowym polu, co~znaczy
¿e~ilo¶c wykrywanej pamiêci jest ograniczona do~64MB.

Pamiêæ wirtulna (VM) jest jednym z~najwa¿niejszych elementów w systemie. Jest odpowiedzilna za tworzenie
wielu przestrzeni adresowych, zarz±dzaniem obszarami pamiêci w segmentach, tworzenie stosów oraz
odwzorowywaniu pamiêci pomiêdzy segmentami i przestrzeniami.

Przestrzenie adresowe s± odwzorowaniem adresów u¿ywanych w instrukcjach procesora na~adresy pamiêci fizycznej.
Jest to~istotny element dla~wielozadaniowo¶ci poniewa¿ zwykle programy nie wspóldziel± pamiêci, a~korzystaj± z tych
samych adresów\footnote{£atwo siê o tym przekonaæ pisz±c prosty program w jêzyku C drukuj±cy na ekran adres
jakiej¶ swojej zmiennej. Je¿eli uruchomimy jednocze¶nie wiele kopii naszego programu to~ka¿dy wydrukuje
ten sam adres, mimo ¿e~ka¿dy ma~swoj± w³asn± pamiêæ.}.

Zrealizowanie pamiêci wirtualnej w~systemie operacyjnym wymaga wsparcia ze~strony sprzêtu. Adresy u¿ywane
w~instrukcjach (adresy wirtualne) procesora musz± zostaæ przez niego przet³umaczone na adresy fizyczne. W tym
celu dzieli siê pamiêæ na ma³e ramki zwanymi stronami pamiêci. Procesor u¿ywa katalogów stron do t³umaczenia
adresów wirtualnych na fizyczne. Pozycje w katalogu, oznaczaj±ce ramki w pamiêci wirtualnej, zawieraj± adresy
stron w pamiêc fizycznej\footnote{Procesory z rodziny x86 pos³uguj± siê stronami wielko¶ci 4kB. Adresy pamiêci
bêdziemy dla wygody zapisywaæ szesnastkowo, rozmiar strony zapisany szesnastkowo to \texttt{0x1000}.}. Przyk³adowo,
je¿eli system operacyjny ramce strony pod adresem \texttt{0x1000} przypiszê stronê o adresie \texttt{0x4000}
to spowoduje to t³umaczenie adresów \texttt{0x1000-0x1fff} z instrukcji na adresy fizyczne \texttt{0x4000-0x4fff}.



% TODO: daæ referencje do tej ksi±¿ki Mateusza z której korzysta³em! wieczyk
Modu³ VM powsta³ pod wp³ywem materia³ów 
omawiaj±cych zarz±dzanie pamiêcia wirtualn± w systemach SVR4 i Mach. Nazewnictwo procedur by³o wzorowane
na drugi z wymienionych modu³ów. 

Modu³ jest podzielony na kilka wartsw. Najni¿sz± warstw± jest \texttt{vm\_pmap} odpowiedzialny za obs³ugê katalogu
stron procesora. Kolejn± wartstw± jest \texttt{vm\_seg} odpowiedzialny za zarz±dzanie segmentami w przestrzeniach
adresowych. Najwy¿sz± wartstw± jest \texttt{vm\_space} odpowiedzialny za zarz±dzanie przestrzeniami adresowymi.


\subsection{Mapa pamiêci.}

Mapa pamiêci u¿ywana przez nasz system jest z~góry ustalona. W~ni¿szych adresach znajdujê siê kod programu
(jest to~poczê¶ci wymuszonê przez u¿ywany format a.out).  Segment stosów u¿ytkownika jest umieszczony tu¿ przed kodem
j±dra i~ro¶nie w~dó³. J±dro jest umieszczone w~wysokich adresach (powy¿ej 3GB) i~jest odwzorowane w~przestrzeñ
adresow± ka¿dego procesu. Pod koniec przestrzeni adresowej znajduj± siê stosy w±tków j±dra i alternatywne stosu w±tków
u¿ytkownika.

OBRAZKI

\subsection{Strony i katalogi stron.}

System opisuje ka¿d± stronê pamiêæi za pomoc± typu \texttt{vm\_page\_t}. Zapisane s± informacje o fizycznym adresie strony,
oraz liczniku referencji do stron. Na wewnêtrzne potrzeby modu³u obs³ugi pamiêci wirtualnej przy niektórych stronach
zapisywana jest tak¿e informacja o adresie ramki, w jaki jest ta strona odwzorowana.
Opisy stron s± trzymane w tablicy \texttt{vm\_pages}, której rozmiar jest taki sam jak ilo¶æ stron w pamiêci komputera.
Tablica s³u¿y te¿ przy t³umaczeniu adresów fizyczny na adresy wirtualne, je¿eli taka informacja zosta³a zapisana.
Przy rozruchu systemu kazda strona znajduj±ca siê za j±drem jest wpiêta w listê wolnych stron \texttt{vm\_free\_pages}.

%TODO: check
T³umaczenie adresów na~procesorach x86 obydwa siê w~dwóch krokach. Pierwszy krok to~segmentacja, gdzie adresy z~instrukcji
s± t³umaczone na~adresy liniowe. Procesor podczas t³umaczenia korzysta z~tablicy deskryptorów, z~której miêdzy innymi
odczytuje informacje o~adresie bazowym i~d³ugo¶ci segmentu. Adres liniowy powstaje poprzez przesuniêcie adresu z~instruckji
o~adres bazowy danego segmentu\footnote{Sama segmentacja spe³nia jeszcze rolê ochronn±, sprawdza czy program nie wyskoczy³
za~segment oraz czy ma odpowiednie prawa dostêpu}. Ta~w³a¶ciwo¶æ nie jest wykorzystywana w~naszym systemie, dlatego wszystkie
adresy bazowe wynosz± 0, dziêki czemu adres liniowy jest to¿samy z~adresem instrukcji\footnote{Popularne systemy jak
FreeBSD, Linux, Solaris,... rownie¿ nie korzytaj± z~tej w³a¶ciwo¶ci. Prawdopodobnie jest to~spowodowane tym, ¿e~jêzyk C
nie wspiera wykorzystania tego mechanizmu. Przesuniêcia spowodowyby ¿e~uzycie adresów z segmentu stosu na~kodzie operuj±cym
na segmeñcie danych by³oby nieprawid³owe. St±d nie mo¿na by³oby u¿ywaæ np procedury \texttt{strlen} i~do~tablic bêd±cych zmiennymi
lokalnymy jak i~do~tablic bêd±cymi zmiennymi globalnymi. Wsparcie wymaga³oby wprowadzenie nowego typu wska¼ników, w~których
oprócz samego adresu by³by zapisany deskryptor segmentu - stare kompilatory jêzyka C na~system DOS w~tym celu rozszerza³y jêzyk 
o~s³ówko kluczowe \texttt{far}.}.

Drugim krokiem jest przet³umaczenie adresu na adres fizyczny z~u¿yciem katalogu stron. Sam katalog stron nie opisuje
z powodów technicznych wszystkich ramek w pamiêci, poniewa¿ stron mo¿e byæ a¿ $2^{24}$ to taki katalog zajmowa³by zbyt
du¿± ilo¶c pamiêci (bior±c pod uwagê ¿e ka¿da przestrzeñ adresowa ma swój katalog stron). Katalog zajmuje jedn± stronê
pamiêci i jest tablic± o 1024 elementach. Ka¿da pozycja w katalogu zawiera adres fizyczny tablicy stron opisuj±cego
4MB pamiêci. Poniewa¿ $1024*4MB=4GB$ to katalog stron opisujê ca³± pamiêæ jak± mog± adresowac programy. Tablica stron
ma tak± sam± budowê jak katalog, z tym ¿e jej pozycje opisuj± fizyczne adresy (zatem ka¿da pozycja tablicy stron opisuje
4kB pamiêci).

Procesor posiada rejestr kontrolny, w którym trzyma fizyczny adres katalogu stron. Ka¿da przestrzeñ adresowa posiada
swój w³asny katalog stron, którego adres jest wpisywany w ten rejestr przy zmianie kontekstu.

Modu³ pamiêci wirtualnej opisuje odwzorowanie stron przez typ \texttt{vm\_pmap\_t}. Przed
programist± systemu dwu stopniowa konstrukcje katalogu jest ukryta, poniewa¿ nie jest to~istotne w~ogólnym zarzadzaniu
pamiêci± oraz zrobi³oby modu³ mniej przeno¶nym.

Operacje na odwzorowaniu zarz±dzaj± licznikiem referencji, odpowiednio zwiêkszaj±c oraz zmniejsz±c przy
dodawaniu i~kasowaniu wpisów. Strony z wyzorowanym licznkiem trafiaj± ponownie na listê wolnych stron i~nadaj± siê do
ponownego u¿ycia. Dodatkowymi operacjami s± rêcznie t³umaczenie adresów fizycznych na wirtualne oraz kopiowania wpisów
pomiêdzy odwzorowaniami.

Ka¿da zmiana katalogu stron powoduje opró¿nienie pamiêci podrêcznej (rejestru TLB) w~procesorze.
W zwi±zku z tym system zaznacza specjalny bit przy wpisach dotycz±cych przestrzeni j±dra mówi±cy
procesorowi ¿e dana pozycja jest globalna, wspólna dla wszystkich tablic. Omija to niepotrzebne wyrzucanie i ponowne
wczytywanie tych samych tablic stron. Rozmiar pamiêci j±dra mo¿e zmieniaæ siê podczas pracy systemu, z tego wynika ¿e mog±
pojawiæ siê nowe tablice stron opisuj±ce nowe pamiêci j±dra. Aby j±dro by³o dalej odwzorowane w ka¿dej przestrzeni nazw
trzeba uaktualniæ ka¿dy katalog dokonuj±c wpisu dotycz±ceg nowej tablicy. Ta techniczna niedogono¶æ jest rozwi±zana przez
przydzielenie dla j±dra wszystkich tablic stron opisuj±cych jego przestrzeñ adresow±. Dla 1GB przestrzeni oznacza to 256 tablic,
³±cznie zajmuj±cych 1MB pamiêci. 


\subsection{Segmenty.}

\subsection{Przestrzenie.}

\subsection{Sterta j±dra.}

\ref{usenix:slab}