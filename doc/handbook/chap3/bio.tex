% Impala Operating System
%
% Copyright (C) 2009 University of Wroclaw. Department of Computer Science
%    http://www.ii.uni.wroc.pl/
% Copyright (C) 2009 Mateusz Kocielski, Artur Koninski, Pawel Wieczorek
%    http://trzask.codepainters.com/impala/trac/
% All rights reserved.
%
% Redistribution and use in source and binary forms, with or without
% modification, are permitted provided that the following conditions
% are met:
% 1. Redistributions of source code must retain the above copyright
%  notice, this list of conditions and the following disclaimer.
% 2. Redistributions in binary form must reproduce the above copyright
%  notice, this list of conditions and the following disclaimer in the
%  documentation and/or other materials provided with the distribution.
%
% THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND
% ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
% IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
% ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE
% FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
% DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
% OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
% HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
% LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
% OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
% SUCH DAMAGE.
%
% $Id$

\section{Strumieniowe wej¶cie-wyj¶cie.}

\section{Buforowane wej¶cie-wyj¶cie.} \label{BIO}

Operacje wej¶cia-wyj¶cia s± na urz±dzeniach blokowych opisywane przez
nag³ówki buforów (\texttt{iobuf\_t}). Ka¿dy nag³ówek buforu zawiera
w~sobie nastêpuj±ce pola:
\begin{itemize}
\item \texttt{addr} - adres bufora
\item \texttt{size} - d³ugo¶c bufora w~bajtach
\item \texttt{bcount} - d³ugo¶c bufora w~blokach
\item \texttt{blkno} - logiczny numer bloku
\item \texttt{flags} - znaczniki
\item \texttt{errno} - numer b³êdu
\item \texttt{oper} - kierunek transferu \texttt{BIO\_READ}
    lub~\texttt{BIO\_WRITE}
\item \texttt{resid} - ilo¶æ pozosta³ych bajtów do~przes³ania (na~potrzeby
sterowników)
\item \texttt{dev} - deskryptor urz±dzenia
\item \texttt{sleepq} - ¶pi±ca kolejka
\end{itemize}

Zdefiniowane znaczniki \texttt{iobuf\_t.flags}:
\begin{itemize}
\item \texttt{BIO\_DONE} - operacja wej¶cia-wyj¶cia zakoñczona
\item \texttt{BIO\_ERROR} - wyst±pi³ b³±d podczas ostatniej operacji wej¶cia-wyj¶cia
\item \texttt{BIO\_VALID} - dane w buforze s± prawid³owe
\item \texttt{BIO\_CACHE} - nag³ówek jest w tablicy haszuj±cej
\item \texttt{BIO\_BUSY} - nag³ówek jest zajêty przez klienta
\end{itemize}

System udostêpnia mechanizm buforowanego wej¶cia-wyj¶cia, który jest warstw±
pomiêdzy swoimi klientami (modu³ami obs³ugi systemów plików) a~sterownikami
urz±dzeñ. Mechanizm pos³uguje siê sta³± ilo¶ci± nag³ówków buforów, które
oprócz opisywania operacji dla sterowników s³u¿± do~zapamiêtywania ich wyników.
Zapamiêtane dane mog± ograniczyæ potrzebê korzystania z~urz±dzenia.


Nale¿y zwróciæ uwagê, ¿e buforowane s± operacje wej¶cia-wyj¶cia, nie sam
no¶nik urz±dzenia. Ta subtelna ró¿nica objawia siê tym, ¿e jeden bufor
mo¿e pamiêtaæ ci±g stu sektorów zaczynaj±c od dwudziestego, a drugi bufor
mo¿e pamiêtaæ ci±g dziesiêcu sektorów zaczynaj±c od piêædziesi±tego tego
samego urz±dzenia.
Mechanizm nie zapewnia, ¿e buforowanie ,,wspólnych'' sektorów  zawiera
te~same dane. Odpowiedzialno¶æ tworzenia sensownych operacji wej¶cia-wyj¶cia
spada na~klientów tego mechanizmu.

\subsection{Tablica haszuj±ca.}

W celu przyspieszenia szukania buforów w~pamiêci system pos³uguje siê
tablica haszuj±c±, która korzysta z funkcji haszuj±cej zale¿nej od~adresu
deskryptora urz±dzenia oraz pierwszego bloku operacji.

\begin{eqnarray*}
 hash(\mbox{\texttt{dev}}, \mbox{{\texttt{blkno}}})
& = &
 h(\mbox{\texttt{adres-deskryptora(dev)}} \times \mbox{({\texttt{blkno}+1)}})\\
 h(k)
& = &
 ((ak + b) \mbox{ mod }p) \mbox{ mod }m
\end{eqnarray*}


Nag³ówki s± nawlekane na~dwie listy, listê wolnych nag³ówków je¿eli z~danego
buforu nikt nie korzysta oraz na listê tablicy haszuj±cej. Przyk³adowa
tablica jest przedstawiona na rysunku \ref{bio:bufhash}.

\begin{figure}
 \centering
 \includegraphics{work/bio_bufhash}
 \caption{Przyk³adowa tablica haszuj±ca. Bloczki z~pierwszej kolumny
 oznaczaja nag³ówki list, a z pozosta³ych kolumn nag³ówki buforów.
 Listy $h[i]$ oznaczaj± listy tablicy haszuj±cej, a \texttt{free} oznacza
 listê wolnych nag³ówków.
}
 \label{bio:bufhash}
\end{figure}

Bufor znajduje siê na~wolnej li¶cie tylko wtedy, gdy nie jest u¿ywany
przez ¿adnego klienta. Mo¿e on te¿ jednocze¶nie znajdowaæ siê w~tablicy
haszuj±cej, co oznacza ¿e buforuje poprzednio wykonan± operacjê.

Tablica haszuj±c± oraz lista wolnych buforów znajduje siê
w~strukturze \texttt{bufhash}. 

\subsection{Cykl ¿ycia nag³owka buforu.}

Sta³a ilo¶æ buforów wymaga ustalenia rygyrystycznych zasad pos³ugiwania siê
nimi. Ka¿dy nag³ówek mo¿e byæ dany jednemu klientowi.

Klient mo¿e otrzymaæ bufor za~pomoc± dwóch procedur \texttt{bio\_getblk}
oraz \texttt{bio\_read}. Obydwie pobieraj± te same argumenty: urz±dzenie
na którym ma byæ wykonany transfer, numer logiczny bloku oraz d³ugo¶æ, która
musi byæ wielokrotno¶ci± sektora danego urz±dzenia.

Procedura \texttt{bio\_getblk} przeszukuje najpierw tablicê haszuj±c±
w~celu znalezienia danej operacji. Je¿eli nag³ówek jest u¿ywany
przez innego klienta, to~klient o~niego prosz±cy jest usypiany
na~¶pi±cej kolejce \texttt{iobuf\_t.sleepq}. Po obudzeniu procedura jest
restartowana, poniewa¿ dany nag³ówek buforu móg³ zmieniæ buforowan± operacjê.

Je¿eli odpowiedni bufor nie zostanie znaleziony w~tablicy haszuj±cej
to~nag³ówek jest przydzielany z~listy wolnych buforów, je¿eli wziêty nag³ówek
znajduje siê równie¿ w tablicy haszuj±cej (to~znaczy buforuje inn± operacjê
ni¿ my szukamy) to nale¿y go z niej usun±æ.

Zdobyty nag³ówek buforu jest organizowany przez procedurê \texttt{buf\_alloc},
która sprawdza czy nie nale¿y przydzieliæ buforu lub zmieniæ rozmiaru
obecnie przydzielonego. Nastêpnie jest naznaczany flag± \texttt{BIO\_BUSY}
i~zwracany klientowi.

Procedura \texttt{bio\_read} jest nak³adk± na~wy¿ej omówion±, je¿eli bufor
nie jest naznaczony flag± \texttt{BIO\_VALID} to~nag³ówek jest przekazywany
jako zlecenie do~sterownika urz±dzenia. W~takim wypadku klient jest blokowany
na~czas wykonania zlecenia.

Operacja zapisu mo¿e zostaæ wykonana za pomoc± operacji \texttt{bio\_write},
po wykonaniu dzia³ania klient musi zwróciæ bufor mechanizmowi u¿ywaj±c
procedury \texttt{bio\_release}.

Dla~sterowników urz±dzeñ s± dostarczone procedury \texttt{bio\_done}
i \texttt{bio\_error} informuj±ce klientów o~zakoñczeniu operacji zleconej
przed dany nag³ówek. Obydwie procedury budz± klienta oczekuj±cego na~bufor
za~pomoc± \texttt{bio\_wait}.

