% Impala Operating System
%
% Copyright (C) 2009 University of Wroclaw. Department of Computer Science
%    http://www.ii.uni.wroc.pl/
% Copyright (C) 2009 Mateusz Kocielski, Artur Koninski, Pawel Wieczorek
%    http://trzask.codepainters.com/impala/trac/
% All rights reserved.
%
% Redistribution and use in source and binary forms, with or without
% modification, are permitted provided that the following conditions
% are met:
% 1. Redistributions of source code must retain the above copyright
%  notice, this list of conditions and the following disclaimer.
% 2. Redistributions in binary form must reproduce the above copyright
%  notice, this list of conditions and the following disclaimer in the
%  documentation and/or other materials provided with the distribution.
%
% THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND
% ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
% IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
% ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE
% FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
% DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
% OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
% HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
% LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
% OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
% SUCH DAMAGE.
%
% $Id$

\section{Buforowane wej¶cie-wyj¶cie (BIO).} \label{bio}

Poniewa¿ urz±dzenia dyskowe s± o~wiele wolniejsze ni¿ procesor komputera
to~op³aca siê zapamiêtywaæ w~pamiêci komputera czê¶c danych z~urz±dzenia.
Operacje czytania danych mog± zostaæ zrealizowane w~bardzo krótkim czasie,
je¿eli oka¿e siê, ¿e porz±dane dane z~urz±dzenia s± ju¿ w~pamiêci.
Za~takie buforowanie operacji na~urz±dzeniach blokowych
(dyskowych) odpowiedzialny jest mechanizm buforowanego wej¶cia-wyj¶cia.

System pos³uguje siê nag³ówkami buforów (\texttt{iobuf\_t}).
System przy rozruchu przydziela ustalon± liczbê takich nag³ówków
(parametr \texttt{iobufs}), a ka¿dy z~nich mo¿e byæ przypisany do~urz±dzenia
oraz numeru bloku(sektoru). Ustalona ilo¶c nag³ówków jest przydzialana przez
system podczas rozruchu (parametr j±dra \texttt{iobufs}) systemu. W celu
przyspieszenia bufory s± trzymane w tablicy haszuj±cej.

\subsection{Tablica haszuj±ca.}

Nag³ówki s± nawlekane na~dwie listy, listê wolnych nag³ówku je¿eli z~danego
buforu nikt nie korzysta oraz na listê tablicy haszuj±cej. Przyk³adowa
tablica jest przedstawiona na rysunku \ref{bio:bufhash}.


\begin{figure}
 \centering
 \includegraphics{work/bio_bufhash}
 \caption{Przyk³adowa tablica haszuj±ca. Bloczki z~pierwszej kolumny
 oznaczaja nag³ówki list, a z pozosta³ych kolumn nag³ówki buforów.
 Listy $h[i]$ oznaczaj± listy tablicy haszuj±cej, a \texttt{free} oznacza
 listê wolnych nag³ówków.
}
 \label{bio:bufhash}
\end{figure}

U¿ywana funkcja haszuj±ca wyra¿a siê wzorem

\begin{eqnarray*}
 hash(\mbox{\texttt{dev}}, \mbox{{\texttt{blkno}}})
& = &
 h(\mbox{\texttt{adres-deskryptora(dev)}} \times \mbox{{\texttt{blkno}}})\\
 h(k)
& = &
 ((ak + b) \mbox{ mod }p) \mbox{ mod }m
\end{eqnarray*}
 

\subsection{Cykl ¿ycia nag³owku buforu.}

Poniewa¿ system pos³uguje siê sta³± ilo¶ci± nag³ówków to~musz± zostaæ
ustalone zasady pos³ugiwania siê nimi przez klientów tego mechanizmu.

Nag³ówki s± identyfikowane przez urz±dzenie i~numer bloku, aby pobraæ nag³ówek
nale¿y u¿yæ procedury \texttt{bio\_getblk}. Procedura sprawdza najpierw, czy
dany sektor z~urz±dzenia nie jest ju¿ zapamiêtany, je¿eli nie jest
to~przydziela nag³owek z~listy wolnych oraz organizuje pamiêæ na bufor.
Zwrócony nag³owek jest naznaczony jako zawieraj±cy nieprawid³owe dane.

Je¿eli nag³ówek zawieraj±cy porz±dane sektory znajduje siê w~pamiêci
to~nale¿y sprawdziæ czy nie jest w³a¶nie u¿ywany przez innego klienta. Je¿eli
tak to w±tek prosz±cy o~nag³ówek jest usypiany, a¿ do momentu mo¿liwo¶ci
przydzielania buforu. W przeciwnym wypadku nale¿y naznaczyæ nag³ówek
jako~u¿ywany i~go zwróciæ.

Inn± drog± otrzymania nag³ówku urz±dzenia jest procedura \texttt{bio\_read},
która jest nak³adk± na~procedurê omówion± wy¿ej. Jej zadaniem jest zlecenie
operacji wej¶cia-wyj¶cia sterownikowi urz±dzenia je¿eli zwrócony nag³owek
jest nieprawid³owy. W tym przypadku równie¿ blokuje obecny w±tek na~czas
wykonania operacji przez sterownik.

Otrzymany nag³ówek nale¿y zwróciæ do mechanizmu za~pomoc± procedury
\texttt{bio\_release} lub \texttt{bio\_write}, gdzie druga, jak wskazuje
nazwa, wysy³a dane z~buforu do~urz±dzenia.

Procedura \texttt{bio\_wait} s³u¿y do~oczekiwania zakoñczenia operacji
wej¶cia-wyj¶cia wykorzystuj±cej dany bufor, jest wewnêtrznie wykorzystywana
przez \texttt{bio\_read} i \texttt{bio\_write}. Sterowniki urz±dzeñ pos³uguj±
siê procedurami \texttt{bio\_done} i \texttt{bio\_error} w~celu poinformowania
mechanizmu o zakoñczeniu.