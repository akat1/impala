% Impala Operating System
%
% Copyright (C) 2009 University of Wroclaw. Department of Computer Science
%    http://www.ii.uni.wroc.pl/
% Copyright (C) 2009 Mateusz Kocielski, Artur Koninski, Pawel Wieczorek
%    http://trzask.codepainters.com/impala/trac/
% All rights reserved.
%
% Redistribution and use in source and binary forms, with or without
% modification, are permitted provided that the following conditions
% are met:
% 1. Redistributions of source code must retain the above copyright
%  notice, this list of conditions and the following disclaimer.
% 2. Redistributions in binary form must reproduce the above copyright
%  notice, this list of conditions and the following disclaimer in the
%  documentation and/or other materials provided with the distribution.
%
% THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND
% ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
% IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
% ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE
% FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
% DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
% OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
% HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
% LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
% OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
% SUCH DAMAGE.
%
% $Id$

\section{Wirtualny system plików (VFS).}
\label{VFS}
% no wiêc najpierw przyda³ by siê jaki¶ wstêp, info o tym, czym s± pliki, jak
% wygl±da ich obs³uga od strony u¿ytkownika
% potem o 
\subsection{Pliki od strony u¿ytkownika.}
Interfejs plików jest jednym z najwa¿niejszych interfejsów jakie programy
maj± do dyspozycji. W systemach Unixowych pliki reprezentuj± ca³± gamê bytów:
\begin{itemize}
\item Pliki w standardowym rozumieniu, jako pewnej d³ugo¶ci ci±g bajtów. Jest
to rodzaj pliku, z jakim u¿ytkownik najczê¶ciej ma kontakt, korzystaj±c
z~sytemów plików takich jak FAT, NTFS, UFS, ext3 itd.
\item Urz±dzenia - zarówno fizycznie istniej±ce w komputerze, jak i wirtualne.
\item Potoki FIFO.
\item Pliki jako wirtualne byty s³u¿±ce do przekazywania ró¿nych informacji 
z~j±dra systemu.
\end{itemize}
Niezale¿nie od tego, co kryje siê pod plikiem, od strony u¿ytkownika posiada
on jednolity interfejs. Najwa¿niejszymi funkcjami wchodz±cymi w jego sk³ad s±:
\texttt{open}, \texttt{close}, \texttt{read}, \texttt{write}, \texttt{ioctl}
\texttt{fcntl}, \texttt{lseek} i \texttt{fstat}. Otwarty plik w programie jest
identyfikowany przy pomocy deskryptora pliku - zazwyczaj ma³ej liczby nieujemnej.
J±dro systemu posiada zwi±zan± z ka¿dym procesem tabelê, s³u¿±c± do t³umaczenia
deskryptora pliku na strukturê \texttt{file\_t}. Wiele deskryptorów plików mo¿e
wskazywaæ na t± sam± strukturê. Oto, jak wygl±da \texttt{file\_t}:

\begin{center}
\begin{tabular}{|ll|l|}
\hline
vnode\_t   & *f\_vnode & Wska¼nik na v-wêze³ zwi±zany z plikiem\\
off\_t     &  f\_offset & Aktualna pozycja kursora w pliku\\
int       &  f\_refcnt & Licznik referencji dla tej struktury\\
int       &  f\_flags & Flagi, pocz±tkowo ustawione przez open\\
\hline
\end{tabular}
\end{center}
 
Tak wiêc wszystkie deskryptory wskazuj±ce na ten sam plik dziel± informacje
takie jak aktualna pozycja kursora oraz flagi pliku. Do pobrania struktury
\texttt{file\_t} na podstawie deskryptora s³u¿y funkcja \texttt{f\_get}.
Tablica deskryptorów plików zosta³a zrealizowana jako lista kawa³ków tablicy
o pojemno¶ci 32 wpisów.

\subsection{Pliki od strony j±dra.}

Wa¿nym zadaniem j±dra systemu operacyjnego jest stworzenie takich warunków,
w których pliki pochodz±ce z ró¿nych systemów plików mog³y byæ obs³ugiwane
przez pojedynczy, uniwersalny interfejs. Takie w³a¶nie zadanie spe³nia
VFS - wirtualny system plików. Zarówno pojêcie pliku jak i systemu plików
zosta³o ujête w ramy ¶ci¶le zdefiniowanych struktur j±dra, ukrywaj±cych
prawdziw± implementacjê powi±zanych z nimi operacji. Pliki s± reprezentowane
przez strukturê \texttt{vnode\_t}, natomiast systemy plików poprzez 
\texttt{vfs\_t}. Projekt VFS-a zawarty w Impali bazowany by³ na tym z SVR4.
\subsubsection{V-wêz³y}
Aby móc zrozumieæ funkcjonowanie wirtualnego systemu plików, wa¿n± jest
znajomo¶æ struktury, do której odnosi siê wiêkszo¶æ operacji.
Oto jak wygl±da v-wêze³:

\begin{center}
\begin{tabular}{|l l| l|}
\hline
int            &~v\_type        & typ v-wêz³a\\
int            &~v\_flags       & flagi v-wêz³a\\
int            &~v\_refcnt      & licznik referencji\\
vfs\_t         &*v\_vfs\_mounted\_here & system plików tutaj zamontowany\\
vfs\_t         &*v\_vfs         & system plików tego vnode\\
vnode\_ops\_t  &*v\_ops         & wska¼nik do \texttt{vnode\_ops} z tego fs\\
devd\_t        &*v\_dev         & urz±dzenie, je¶li to v-wêze³ urz±dzenia\\
void           &*v\_private     & prywatne dane systemu plików, np. i-wêze³\\
mutex\_t       &~v\_mtx         & blokada do synchronizacji\\
\hline
\end{tabular}
\end{center}

Impala posiada nastêpuj±ce typy v-wêz³ów:
\begin{center}
\begin{tabular}{lcl}
VNODE\_TYPE\_REG & - &zwyk³y plik \\
VNODE\_TYPE\_DIR & - &plik reprezentuj±cy katalog \\
VNODE\_TYPE\_DEV & - &plik reprezentuj±cy urz±dzenie \\
VNODE\_TYPE\_LNK & - &plik bêd±cy dowi±zaniem symbolicznym \\
VNODE\_TYPE\_FIF & - &plik reprezentuj±cy potok \\
\end{tabular}
\end{center}

Operacje mo¿liwe do wykonania na v-wê¼le ukryte s± w strukturze
\texttt{vnode\_ops\_t} dostarczanej dla ka¿dego v-wêz³a przez zwi±zany z nim
system plików. Struktura ta zawiera wska¼niki do funkcji wykonuj±cych wszystkie
przewidziane przez nas operacje, jakie s± mo¿liwe do wykonania na pliku.
Szczegó³owo zosta³a ona przedstawiona w tabeli \ref{vnodeops}.

Dla wygody korzystania z v-wêz³ów dla ka¿dej z operacji wprowadzono
odpowiednie makro \texttt{VOP\_XXX(v, ...)} wykonuj±ce operacjê \texttt{XXX}
na v-wê¼le \texttt{v}.
Dla dalszego u³atwienia pracy z v-wêz³ami, wprowadzono nastêpuj±ce ogólne
procedury:
\begin{itemize}
\item \texttt{vnode\_opendev} - otwiera vnode urz±dzenia o podanej nazwie
\item \texttt{vnode\_rdwr}, \texttt{vnode\_urdwr} - wykonuj± operacje odczytu
i zapisu do danego v-wêz³a
\item \texttt{vnode\_stat} - pobiera ró¿ne informacje o pliku
\item \texttt{vnode\_isatty} - sprawdza czy v-wêze³ zwi±zany jest z terminalem
\item \texttt{vnode\_access\_ok} - weryfikuje uprawnienia danego procesu do
dostêpu do pliku z zamiarem wykonania podanych operacji
\item \texttt{vnode\_alloc} - przydziela now±, pust± strukturê v-wêz³a
\item \texttt{vrele} - zwalnia dan± referencjê do v-wêz³a
\item \texttt{vref} - tworzy now± referencjê do v-wêz³a
\end{itemize}
W kwestii zliczania referencji, przyjêta przez nas strategia zak³ada, ¿e
ka¿da funkcja zwracaj±ca w wyniku v-wêze³, musi zwróciæ go ze zwiêkszon± ju¿
liczb± referencji (tj. wykonanym \texttt{vref}). Dziêki temu, eliminujemy
jedn± z mo¿liwych sytuacji wy¶cigu. Procedura wywo³uj±ca staje siê w ten sposób
w³a¶cicielem zwróconego wska¼nika do v-wêz³a. Je¿eli nie bêdzie ju¿ wiêcej z
niego korzysta³a, musi wykonaæ na nim \texttt{vrele}.

Kolejnym ustaleniem, jest to, ¿e funkcja, która dosta³a v-wêze³ jako argument,
mo¿e bez przeszkód z niego korzystaæ, o ile nie zachowuje tego wska¼nika na pó¼niej.
Ka¿de klonowanie wska¼nika wymaga wywo³ania funkcji \texttt{vref}.
Wyra¼nie oznaczone funkcje mog± jednak przejmowaæ prawo w³asno¶ci do referencji
od strony wywo³uj±cej. Jest to wykorzystywane dla wygody, w sytuacjach, gdy po
wykonaniu procedury dalszy dostêp do obiektu nie jest zazwyczaj potrzebny.

Podobna strategia zosta³a zastosowana w odniesieniu do struktury \texttt{file\_t}.
Odpowiednie funkcje maj± nazwy \texttt{frele} i \texttt{fref}.

W przypadku zwalniania ostatniej referencji do v-wêz³a, wykonywana jest na nim
operacja \texttt{VOP\_INACTIVE}, maj±ca na celu poinformowanie i-wêz³a (zale¿nej
od sytemu plików czê¶ci v-wêz³a) o tej sytuacji. Umo¿liwi to wykonanie koñcowych
czynno¶ci, takich jak zwolnienie i-wêz³a.
\begin{table}
\begin{tabular}{|l l|p{9cm}|}
\hline
vnode\_open\_t      &*vop\_open&Otwieranie pliku \\
vnode\_create\_t    &*vop\_create&Tworzenie nowego pliku \\
vnode\_close\_t     &*vop\_close&Zamykanie pliku \\
vnode\_read\_t      &*vop\_read&Odczytywanie z pliku \\
vnode\_write\_t     &*vop\_write&Zapisywanie do pliku \\
vnode\_ioctl\_t     &*vop\_ioctl&Wykonywanie dodatkowych operacji \\
vnode\_seek\_t      &*vop\_seek&Sprawdzanie, czy dana pozycja jest prawid³owa\\
vnode\_truncate\_t  &*vop\_truncate&Zmiana rozmiaru pliku\\
vnode\_getattr\_t   &*vop\_getattr&Pobieranie ró¿nych atrybutów pliku\\
vnode\_setattr\_t   &*vop\_setattr&Ustawianie atrybutów pliku\\
vnode\_lookup\_t    &*vop\_lookup&Poszukiwanie v-wêz³a o podanej nazwie, pocz±wszy
    od danego v-wêz³a katalogu\\
vnode\_mkdir\_t     &*vop\_mkdir&Tworzenie nowego katalogu\\
vnode\_getdents\_t  &*vop\_getdents&Pobieranie zawarto¶ci katalogu\\
vnode\_readlink\_t  &*vop\_readlink&Odczytywanie nazwy pliku, na który wskazuje
    dowi±zanie symboliczne\\
vnode\_symlink\_t   &*vop\_symlink&Tworzenie dowi±zania symbolicznego\\
vnode\_access\_t    &*vop\_access&Sprawdzanie praw dostêpu do pliku\\
vnode\_sync\_t      &*vop\_sync&Synchronizowanie stanu pliku w pamiêci ze stanem
    na trwa³ym no¶niku\\
vnode\_inactive\_t  &*vop\_inactive&Informowanie pliku, ¿e ostatnia referencja
do tego v-wêz³a jest w³a¶nie usuwana\\
vnode\_lock\_t      &*vop\_lock&Blokowanie pliku\\
vnode\_unlock\_t    &*vop\_unlock&Odblokowywanie pliku\\
vnode\_rmdir\_t     &*vop\_rmdir&Usuwanie katalogu\\
vnode\_link\_t      &*vop\_link&Podwi±zywanie istniej±cego pliku pod now± nazw±\\
vnode\_unlink\_t    &*vop\_unlink&Usuwanie wpisu z katalogu\\
\hline
\end{tabular}
\caption{Struktura v-wêz³a - \texttt{vnode\_t}}
\label{vnodeops}
\end{table}
\subsection{System plików.}
Struktura reprezentuj±ca zamontowane systemy plików jest analogiczna do
struktury v-wêz³a, jednak¿e zwi±zane z ni± operacje s± mniej liczne:
\begin{center}
\begin{tabular}{|l l| l|}
\hline
vfs\_ops\_t    &*vfs\_ops &   definicje operacji zwi±zanych z tym systemem plików\\
vnode\_t      &*vfs\_mpoint &  v-wêze³ który przykryli¶my montuj±c ten s. plików\\
devd\_t       &*vfs\_mdev &    urz±dzenie, u¿ywane przez ten s. plików\\
void         &*vfs\_private & prywatne dane systemu plików\\
vfs\_conf\_t   &*vfs\_conf &  struktura definiuj±ca typ zamontowanego systemy plików\\
list\_node\_t  &~L\_mountlist & wêze³ z listy zamontowanych fs\\
\hline
\end{tabular}
\end{center}
Operacje, mo¿liwe do wykonania na systemie plików to montowanie systemu plików,
odmontowywanie go, synchronizowanie jego stanu z pamiêci± trwa³±, oraz pobranie
v-wêz³a katalogu g³ównego systemu plików. Podobnie jak przy v-wêz³ach, dla
wygody korzystania z tych operacji utworzone zosta³y makra, o nazwach
\texttt{VFS\_XXX}.
W chwili obecnej ¿aden z systemów plików nie posiada zaimplementowanej obs³ugi
odmontowywania systemu plików.
Do montowania systemu plików istnieje dodatkowa funkcja \texttt{vfs\_mount}
korzystaj±ca z makra \texttt{VFS\_MOUNT} i wykonuj±ca wszelkie niezbêdne czynno¶ci
potrzebne do zamontowania systemu plików na podstawie v-wêz³a punktu montowania,
informacji o nazwie systemu plików oraz strukturze urz±dzenia które nale¿y zamontowaæ.

Zaimplementowane w Impali systemy plików to:
\begin{itemize}
\item MFS - pamiêciowy system plików, zamontowany jako korzeñ drzewa katalogów.
\item FAT12 - system plików potrzebny do odczytania danych z dyskietki. Dyskietka
jest domy¶lnie montowana w systemie plików pod katalogiem \texttt{/mnt/fd0/}.
\item devfs - system pe³ni±cy rolê pojemnika na pliki urz±dzeñ, a tak¿e po¶rednika
miêdzy interfejsem plików a interfejsem urz±dzeñ. Domy¶lnie zamontowany 
w~\texttt{/dev/}.
\item fifofs - system plików na u¿ytek plików potoków. Nie obs³uguje on funkcji
montowania.
\end{itemize}

Wszystkie te systemy plików kompilowane s± do pojedynczej biblioteki 
\texttt{libfs.a} udostêpniaj±cej tablicê funkcji inicjalizacji poszczególnych
systemów plików \texttt{fstab}. Funkcje zawarte w tej tabeli s± automatycznie
wykonywane podczas inicjalizacji wirtualnego systemu plików.

Jedn± z wa¿niejszych funkcji, udostêpnionych przez
podsystem VFS, jest \texttt{vfs\_lookup}. S³u¿y ona do zlokalizowania
v-wêz³a pliku na podstawie ¶cie¿ki dostêpu. Implementuje ona standardowy
schemat rozwi±zywania ¶cie¿ek.